document.getElementById("schedule-post").addEventListener("click", function() {
    let imageInput = document.getElementById("image-upload");
    if (imageInput.files.length === 0) {
        alert("‚ùå Please select an image.");
        return;
    }

    let caption = document.getElementById("caption-status").textContent.includes("‚úÖ Caption Added:")
        ? document.getElementById("caption-status").textContent.replace("‚úÖ Caption Added: ", "").trim()
        : "";
    let scheduleDate = document.getElementById("schedule-date").value.trim();
    let scheduleTime = document.getElementById("schedule-time").value.trim();
    let scheduleDateTime = `${scheduleDate} ${scheduleTime}`;

    if (caption === "" || scheduleDate === "" || scheduleTime === "") {
        alert("‚ùå Please enter a caption and select a date & time.");
        return;
    }

    let imageFile = imageInput.files[0];
    let reader = new FileReader();

    reader.onloadend = function() {
        let base64Image = reader.result.split(",")[1]; // Extract Base64 content

        let formData = new FormData();
        formData.append("image", base64Image);

        fetch("https://api.imgbb.com/1/upload?expiration=600&key=56e75859f2e844533e76f6829a52c173", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: new URLSearchParams({ image: base64Image }) // Correctly encoding the Base64 string
        })
        .then(response => response.json())
        .then(data => {
            if (!data.success) throw new Error(`Image upload failed: ${data.error.message}`);

            let imageUrl = data.data.url;
            let postData = {
                image: imageUrl,
                caption: caption,
                scheduled_time: scheduleDateTime
            };

            console.log("üì§ Sending post data to Make.com:", postData);

            return fetch("https://hook.eu2.make.com/tm8tj1xohh2eh6bs5b0gw9irhlpuqmj2", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(postData)
            });
        })
        .then(response => {
            if (!response.ok) {
                throw new Error("Failed to send post to Make.com");
            }
            return response.json();
        })
        .then(() => {
            alert("üéâ Post Sent to Make.com Successfully!");
        })
        .catch(error => {
            console.error("‚ùå Error:", error);
            alert(`Failed to send post to Make.com. ${error.message}`);
        });
    };

    reader.readAsDataURL(imageFile);
});
